#!/bin/bash
TARGET_FILE=${BASH_SOURCE[0]}
cd `dirname $TARGET_FILE`
TARGET_FILE=`basename $TARGET_FILE`
while [ -L "$TARGET_FILE" ]
do
    TARGET_FILE=`readlink $TARGET_FILE`
    cd `dirname $TARGET_FILE`
    TARGET_FILE=`basename $TARGET_FILE`
done
PHYS_DIR=`pwd -P`
npm_path=`dirname $PHYS_DIR/$TARGET_FILE`
user=$(who am i)
if [ -z $user ]; then
	user=$(whoami)
fi

user=$( echo $user | awk '{print $1}')
if [ -e /home/$user/.bashrc ]; then
	source_file="/home/$user/.bashrc"
elif [ -e /Users/$user/.bash_profile ]; then
	source_file="/Users/$user/.bash_profile"
elif [ -e /c/Users/$user/.bashrc ]; then
	source_file="/c/Users/$user/.bashrc"
fi

if [ ! -z $source_file ]; then
	bash_comment="# added for npm-completion https://github.com/Jephuff/npm-bash-completion"
	bash_variable="PATH_TO_NPM_COMPLETION=\"$npm_path\""
	npm_source="source \$PATH_TO_NPM_COMPLETION/npm-completion.sh"

	grep -F "$bash_comment" $source_file > /dev/null
	if [ $? != 0 ]; then
		printf "\n$bash_comment" >> $source_file
	fi

	grep -F "$bash_variable" $source_file > /dev/null
	if [ $? != 0 ]; then
		printf "\n$bash_variable" >> $source_file
	fi

	grep -F "$npm_source" $source_file > /dev/null
	if [ $? != 0 ]; then
		printf "\n$npm_source" >> $source_file
	fi

	echo -e "\nadd this line to a cron job or startup script"
	echo "    PATH=\$PATH:$(dirname $(which node)):$(dirname $(which npm)) && cd $npm_path && ./update"
	echo -e "\nrestart terminal to start using\n"
else
	echo -e "\ncouldn't find ~/.bashrc or ~/.bash_profile. Please create one of these file and run\n    npm-completion-setup\n"
fi
